
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>

  <link href="custom.css" rel="stylesheet">
</head>
<body>

<div class="container">
  <h2>Rostopic Mapper</h2>
  <hr/>
  <h4 id="local_ip"></h6>
  <!-- <hr/>
  <button id="load_data" class="btn btn-default">Upload File</button>
  <hr/>
  <form>
    <div id="computer_fields"></div>
    <button id="new_computer_field" class="btn btn-default">Add Computer</button><br>
    <button id="submit_computer_fields" class="btn btn-default">Submit</button>
  </form>
  <hr/>
  <form>
    <div id="rostopic_fields"></div>
    <button id="new_rostopic_field" class="btn btn-default">Add Rostopic Route</button><br>
    <button id="refresh_rostopic_fields" class="btn btn-default">Refresh</button>
  </form> -->
  <hr/>
  <!-- <button id="start_routing" class="btn btn-default">Start Routing</button> -->
  <button id="green_on" class="btn btn-default">Green Lights On</button>
  <hr/>
  <button id="green_off" class="btn btn-default">Green Lights Off</button>

  <script type="text/javascript" type="text/javascript">

    function get_ip_address() {
      $.get("http://ipinfo.io", function(response) {
        console.log(response.ip);
        document.getElementById('local_ip').innerHTML = "Local IP Address: " + response.ip;
      }, "jsonp");
    }

    get_ip_address();

// ---------------------------------------------------------
    document.getElementById("green_on").addEventListener("click", function(event){
      event.preventDefault();
      var ros = new ROSLIB.Ros({
        url : 'ws://18.111.110.236:9090'
      });
      var cmd_topic = new ROSLIB.Topic({
        ros : ros,
        name : '/chatter',
        messageType : 'std_msgs/String'
      });
      var twist = new ROSLIB.Message({
        data : "green_on"
      });
      cmd_topic.publish(twist);
    });
    document.getElementById("green_off").addEventListener("click", function(event){
      event.preventDefault();
      var ros = new ROSLIB.Ros({
        url : 'ws://18.111.110.236:9090'
      });
      var cmd_topic = new ROSLIB.Topic({
        ros : ros,
        name : '/chatter',
        messageType : 'std_msgs/String'
      });
      var twist = new ROSLIB.Message({
        data : "green_off"
      });
      cmd_topic.publish(twist);
    });

// --------------------------------------------------------------------------------------
    var computer_num = 0;
    var computer_list = [];
    document.getElementById("new_computer_field").addEventListener("click", function(event){
      event.preventDefault();
      new_computer_field();
    });
    function new_computer_field() {
      computer_num += 1;
      computer_list.push(new computer());
      console.log(computer_list.length);
      $('#computer_fields').append(
        "<br>\
        <div class=\"form-group\">\
          <label for=\"email\">Computer " + computer_num + ":</label>\
          <input type=\"email\" class=\"form-control\" id=\"computer_" + computer_num + "\" placeholder=\"Enter name\">\
        </div>\
        <div class=\"form-group\">\
          <label for=\"pwd\">IP Address " + computer_num + ":</label>\
          <input type=\"text\" class=\"form-control\" id=\"ip_" + computer_num + "\" placeholder=\"Enter IP\">\
        </div>");
    }
    document.getElementById("submit_computer_fields").addEventListener("click", function(event){
      event.preventDefault();
      update_fields();
    });
    function update_fields() {
      for (var i = 0; i < computer_list.length; i++) {
        var comp_id = 'computer_' + (i+1);
        var name = document.getElementById(comp_id).value;
        var ip_id = 'ip_' + (i+1);
        var ip = document.getElementById(ip_id).value;
        computer_list[i].initialize(name, ip);
      }
      console.log(computer_list);
    }
    function computer() {
      var obj = {};
      obj.name = "";
      obj.ros;
      obj.initialize = function(name, ip_address) {
        obj.name = name
        obj.ros = new ROSLIB.Ros({
          url : 'ws://' + ip_address + ':9090'
        });
      }
      return obj;
    }
// ------------------------------------------------------------------------

    var rostopic_num = 0;
    var rostopic_list = [];

    document.getElementById("new_rostopic_field").addEventListener("click", function(event){
      event.preventDefault();
      new_rostopic_field();
    });
    function new_rostopic_field() {
      rostopic_num += 1;
      rostopic_list.push(new rostopic_route());
      console.log(rostopic_list.length);
      $('#rostopic_fields').append(
        "<br>\
        <div class=\"form-group\">\
          <label for=\"sel1\">Computer</label>\
          <select class=\"form-control\" id=\"subscribe_computers_" + rostopic_num + "\"></select>\
        </div>\
        <div class=\"form-group\">\
          <label for=\"pwd\">Subscribe Topic</label>\
          <input type=\"text\" class=\"form-control\" id=\"sub_topic_" + rostopic_num + "\" placeholder=\"Enter topic\">\
        </div>\
        <div class=\"form-group\">\
          <label for=\"sel1\">Destination</label>\
          <select class=\"form-control\" id=\"publish_computers_" + rostopic_num + "\"></select>\
        </div>\
        <div class=\"form-group\">\
          <label for=\"pwd\">Publish Topic</label>\
          <input type=\"text\" class=\"form-control\" id=\"pub_topic_" + rostopic_num + "\" placeholder=\"Enter topic\">\
        </div>");
    }

    document.getElementById("refresh_rostopic_fields").addEventListener("click", function(event){
      event.preventDefault();
      update_rostopic_dropdowns();
    });
    function update_rostopic_dropdowns() {
      for (var i = 0; i < rostopic_list.length; i++) {
        var sub_comp_div = document.getElementById('subscribe_computers_' + (i+1) );
        var pub_comp_div = document.getElementById('publish_computers_' + (i+1) );
        sub_comp_div.innerHTML = "";
        pub_comp_div.innerHTML = "";
        for (var j = 0; j < computer_list.length; j++) {
          var name = computer_list[j].name;
          if (name != "") {
            sub_comp_div.innerHTML += "<option>" + name + "</option>";
            pub_comp_div.innerHTML += "<option>" + name + "</option>";
          }
        }
      }
    }
    function rostopic_route() {
      var obj = {};
      obj.comp_name = "";
      obj.sub_topic;
      obj.pub_topic;
      obj.initialize = function(sub_comp, sub_topic, pub_comp, pub_topic) {
        // obj.name = name;
        console.log(sub_comp);
        console.log(sub_topic);
        console.log(pub_comp);
        console.log(pub_topic);

        var sub_computer;
        var pub_computer;
        for (var i = 0; i < computer_list.length; i++ ) {
          if (sub_comp == computer_list[i].name) {
            sub_computer = computer_list[i].ros;
            console.log(sub_computer);
          }
        }
        for (var i = 0; i < computer_list.length; i++ ) {
          if (pub_comp == computer_list[i].name) {
            pub_computer = computer_list[i].ros;
            console.log(pub_computer);
          }
        }

        message_type = 'std_msgs/String'

        obj.sub_topic = new ROSLIB.Topic({
          ros : sub_computer,
          name : sub_topic,
          messageType : message_type
        });

        obj.pub_topic = new ROSLIB.Topic({
          ros : pub_computer,
          name : pub_topic,
          messageType : message_type
        });

        obj.sub_topic.subscribe(function(message) {
          console.log('Received message on ' + sub_topic.name + ': ' + sub_topic.data);
          // listener.unsubscribe();
          obj.pub_topic.publish(message);
        });

      }
      return obj;
    }
    function update_rostopic_routes() {
      // console.log("here we go :D");
      for (var i = 0; i < rostopic_list.length; i++) {
        var sub_comp = document.getElementById('subscribe_computers_' + (i+1) ).value;
        var sub_topic = document.getElementById('sub_topic_' + (i+1) ).value;
        var pub_comp = document.getElementById('publish_computers_' + (i+1) ).value;
        var pub_topic = document.getElementById('pub_topic_' + (i+1) ).value;
        rostopic_list[i].initialize(sub_comp, sub_topic, pub_comp, pub_topic);
      }
    }
    document.getElementById("start_routing").addEventListener("click", function(event){
      event.preventDefault();
      update_rostopic_routes();
    });
  </script>
</div>

</body>
</html>
